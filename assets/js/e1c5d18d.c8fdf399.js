"use strict";(self.webpackChunkgrc=self.webpackChunkgrc||[]).push([[4732],{9866:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"hpc-tutorials/cpp-introduction/cpp-build-manually","title":"Building C++ Code Manually","description":"In this section, we have five objectives:","source":"@site/docs/02-hpc-tutorials/04-cpp-introduction/02-cpp-build-manually.md","sourceDirName":"02-hpc-tutorials/04-cpp-introduction","slug":"/hpc-tutorials/cpp-introduction/cpp-build-manually","permalink":"/docs/hpc-tutorials/cpp-introduction/cpp-build-manually","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Hello World","permalink":"/docs/hpc-tutorials/cpp-introduction/cpp-hello-world"},"next":{"title":"Building C++ with CMake","permalink":"/docs/hpc-tutorials/cpp-introduction/cpp-build-with-cmake"}}');var s=n(4848),r=n(8453);const l={},t="Building C++ Code Manually",o={},c=[{value:"Setup + Repo Structure",id:"setup--repo-structure",level:2},{value:"Database Library Header",id:"database-library-header",level:2},{value:"Database Library Source",id:"database-library-source",level:2},{value:"Grocery Database Source",id:"grocery-database-source",level:2},{value:"Movies Database Source",id:"movies-database-source",level:2},{value:"C++ Compiler Pipeline",id:"c-compiler-pipeline",level:2},{value:"The Build Directory",id:"the-build-directory",level:2},{value:"Compile + Assemble database_lib.cc",id:"compile--assemble-database_libcc",level:2},{value:"Fix 1: The -I flag",id:"fix-1-the--i-flag",level:3},{value:"Fix 2: Environment Variables",id:"fix-2-environment-variables",level:3},{value:"Link database_lib.o",id:"link-database_libo",level:2},{value:"Create the Executables",id:"create-the-executables",level:2},{value:"Fix 1: The -L flag",id:"fix-1-the--l-flag",level:3},{value:"Fix 2: Environment Variables",id:"fix-2-environment-variables-1",level:3},{value:"Run the Executable",id:"run-the-executable",level:2},{value:"Fix 1: Install the shared objects",id:"fix-1-install-the-shared-objects",level:3},{value:"Fix 2: Environment Variables",id:"fix-2-environment-variables-2",level:3},{value:"Introduce Compiler Optimization",id:"introduce-compiler-optimization",level:2}];function d(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.header,{children:(0,s.jsx)(i.h1,{id:"building-c-code-manually",children:"Building C++ Code Manually"})}),"\n",(0,s.jsx)(i.p,{children:"In this section, we have five objectives:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsx)(i.li,{children:"How to compile a program into a shared object"}),"\n",(0,s.jsx)(i.li,{children:"How to compile a program into an executable"}),"\n",(0,s.jsx)(i.li,{children:"How to link a shared object to an executable"}),"\n",(0,s.jsx)(i.li,{children:"How to run an executable which relies on a shared object"}),"\n",(0,s.jsx)(i.li,{children:"How to tell the compiler to optimize code"}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["An ",(0,s.jsx)(i.strong,{children:"executable"})," is a piece of code that can be run in a terminal to produce\nsome sort of output. A ",(0,s.jsx)(i.strong,{children:"shared object"})," is code that an executable relies on,\nbut in and of itself is not executable. Shared objects are the primary way that\nC++ enables software to be re-used across code bases and avoid code duplication."]}),"\n",(0,s.jsx)(i.p,{children:"Imagine you have two services:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsx)(i.li,{children:"A movie database which tracks information such as movie description,\nuser reviews, critic reviews, actors, etc."}),"\n",(0,s.jsx)(i.li,{children:"A grocery database which tracks information such as product name,\nproduct description, quantity available, price, etc."}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"Both services are databases. Databases provide a few general functions: creating\nrecords, reading records, updating records, and deleting records (CRUD). As\nopposed to developing entire database management systems for these two use\ncases, one could develop a single generic database technology, and then build\nthe movie and grocery databases using that single technology."}),"\n",(0,s.jsx)(i.p,{children:"In C++, this can be done using a shared library. In our example:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.a,{href:"https://github.com/grc-iit/grc-tutorial/blob/main/cpp/01-cpp-build-manually/src/database_lib.cc",children:"src/database_lib.cc"})," implements the Create, Read, Update, Delete (CRUD) operations."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.a,{href:"https://github.com/grc-iit/grc-tutorial/blob/main/cpp/01-cpp-build-manually/src/grocery_db.cc",children:"src/grocery_db.cc"})," implements the grocery database using CRUD operations"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.a,{href:"https://github.com/grc-iit/grc-tutorial/blob/main/cpp/01-cpp-build-manually/src/movies_db.cc",children:"src/movies_db.cc"})," implements the movie database using CRUD operations"]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"setup--repo-structure",children:"Setup + Repo Structure"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"git clone https://github.com/grc-iit/grc-tutorial.git\ncd grc-tutorial\nexport GRC_TUTORIAL=${PWD}\ncd ${GRC_TUTORIAL}/cpp/02-cpp-build-manually\n"})}),"\n",(0,s.jsx)(i.p,{children:"In this example, our repo is structured as follows:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsx)(i.li,{children:"src: contains all source files"}),"\n",(0,s.jsx)(i.li,{children:"include: contains all header files"}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"This is the typical way a C++ repo is structured. This is because in many cases\nheader files are meant to be public and available to other programs, whereas\nsource files are almost always private. Having them in separate directories\nmakes accomplishing these two objectives much easier."}),"\n",(0,s.jsx)(i.h2,{id:"database-library-header",children:"Database Library Header"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-cpp",children:"#ifndef DATABASE_LIB_H\n#define DATABASE_LIB_H\n\n#include <string>\n\nclass Database {\n public:\n  std::string file_;\n\n  Database(const std::string &file) : file_(file) {}\n\n  void create();\n  void read();\n  void update();\n  void del();\n};\n\n#endif\n"})}),"\n",(0,s.jsx)(i.p,{children:"The header file defines the Database class. The class contains the CRUD\nmethods. The methods aren't implemented here in this case. Their implementation\nis in the source file."}),"\n",(0,s.jsx)(i.h2,{id:"database-library-source",children:"Database Library Source"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-cpp",children:'#include <iostream>\n#include "database_lib.h"\n\nvoid Database::create() {\n  std::cout << file_ << ": in create" << std::endl;\n}\n\nvoid Database::read() {\n  std::cout << file_ << ": in read" << std::endl;\n}\n\nvoid Database::update() {\n  std::cout << file_ << ": in update" << std::endl;\n}\n\nvoid Database::del() {\n  std::cout << file_ << ": in delete" << std::endl;\n}\n'})}),"\n",(0,s.jsx)(i.p,{children:'The source file implements the Database methods. In this case, all they\ndo is make print statements for simplicity. We include "database_lib.h"\nin order to find the Database class we\'re implementing.'}),"\n",(0,s.jsx)(i.h2,{id:"grocery-database-source",children:"Grocery Database Source"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-cpp",children:'#include "database_lib.h"\n\nint main() {\n  Database db("grocery");\n  db.create();\n  db.read();\n  db.update();\n  db.del();\n}\n'})}),"\n",(0,s.jsx)(i.p,{children:'Here we create the grocery database by creating the Database class\nlocated in "database_lib.h".'}),"\n",(0,s.jsx)(i.h2,{id:"movies-database-source",children:"Movies Database Source"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-cpp",children:'#include "database_lib.h"\n\nint main() {\n  Database db("movies");\n  db.create();\n  db.read();\n  db.update();\n  db.del();\n}\n'})}),"\n",(0,s.jsx)(i.p,{children:'Here we create the movies database by creating the Database class\nlocated in "database_lib.h".'}),"\n",(0,s.jsx)(i.h2,{id:"c-compiler-pipeline",children:"C++ Compiler Pipeline"}),"\n",(0,s.jsx)(i.p,{children:"C/C++ compilers are divided into 4 phases:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Preprocessing"}),": This will locate and load #include files and make simple\nmodifications to source code"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Compiling"}),": Will turn the pre-processed source code into assembly code."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Assembling"}),": Will convert assembly code into machine code\n(i.e., object code)."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Linking"}),": Will locate shared libraries and ensure that any missing symbols\nare resolved in the object code."]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"the-build-directory",children:"The Build Directory"}),"\n",(0,s.jsx)(i.p,{children:"First, we should make a build directory to store our files. This\nmakes cleaning up intermediate files much easier."}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"mkdir build\n"})}),"\n",(0,s.jsx)(i.h2,{id:"compile--assemble-database_libcc",children:"Compile + Assemble database_lib.cc"}),"\n",(0,s.jsx)(i.p,{children:"We first try to compile the database into an object file below"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"g++ src/database_lib.cc -fpic -c -o build/database_lib.o\n"})}),"\n",(0,s.jsx)(i.p,{children:"-fPIC stands for Force Poisition Independent Code. Whenever trying to\nbuild a shared object, this is necessary. This is because a shared library\ncan be loaded at different locations in a program, so having the addresses\nin the code being fixed is problematic."}),"\n",(0,s.jsx)(i.p,{children:"-c tells g++ to build the object file."}),"\n",(0,s.jsx)(i.p,{children:"-o database_lib/database_lib.o sets the output of the\ncompilation to be database_lib/database_lib.o."}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.strong,{children:"You should receive the following error"}),":\n",(0,s.jsxs)("pre",{children:[(0,s.jsx)("b",{children:"src/database_lib.cc:2:10:"})," ",(0,s.jsx)("font",{color:"#EF2929",children:(0,s.jsx)("b",{children:"fatal error: "})}),"database_lib.h: No such file or directory\n2 | #include ",(0,s.jsx)("font",{color:"#EF2929",children:(0,s.jsx)("b",{children:'"database_lib.h"'})}),"\n|          ",(0,s.jsx)("font",{color:"#EF2929",children:(0,s.jsx)("b",{children:"^~~~~~~~~~~~~~~~"})}),"\ncompilation terminated."]})]}),"\n",(0,s.jsx)(i.p,{children:"This is because the compiler doesn't know to look in the include directory\nfor the database_lib.h file. In order to force the compiler to search for\nthis file there are two options."}),"\n",(0,s.jsx)(i.h3,{id:"fix-1-the--i-flag",children:"Fix 1: The -I flag"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"g++ src/database_lib.cc -I${PWD}/include -fpic -c -o build/database_lib.o\n"})}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.code,{children:"-I${PWD}/include"})," will ensure the compiler searches the include directory\nfor headers"]}),"\n",(0,s.jsx)(i.h3,{id:"fix-2-environment-variables",children:"Fix 2: Environment Variables"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"INCLUDE=${PWD}/include \\\nCPATH=${PWD}/include \\\ng++ src/database_lib.cc -fpic -c -o build/database_lib.o\n"})}),"\n",(0,s.jsx)(i.p,{children:"INCLUDE and CPATH are sometimes searched by the compiler for header files.\nThis approach is also viable because you don't need to modify build scripts in\norder for it to work."}),"\n",(0,s.jsx)(i.h2,{id:"link-database_libo",children:"Link database_lib.o"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"g++ -shared build/database_lib.o -o build/libdatabase_lib.so\n"})}),"\n",(0,s.jsx)(i.p,{children:'This command will produce the shared library. Note, the general naming\nconvention of a shared object is "libNAME.so". Many compilers expect\nyour shared object to begin with the word "lib" and have an "so"\nextension.'}),"\n",(0,s.jsx)(i.h2,{id:"create-the-executables",children:"Create the Executables"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"g++ src/grocery_db.cc -I${PWD}/include -ldatabase_lib -o grocery_db\ng++ src/movies_db.cc -I${PWD}/include -ldatabase_lib -o movies_db\n"})}),"\n",(0,s.jsx)(i.p,{children:"-ldatabase_lib tells the compiler to search for libdatabase_lib.so"}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.strong,{children:"You should receive the following error"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"/usr/bin/ld: cannot find -ldatabase_lib\ncollect2: error: ld returned 1 exit status\n"})}),"\n",(0,s.jsx)(i.p,{children:"This is because the compiler doesn't know where to search for libdatabase_lib.so.\nWe have to tell it to search the build directory. There are two fixes."}),"\n",(0,s.jsx)(i.h3,{id:"fix-1-the--l-flag",children:"Fix 1: The -L flag"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"g++ src/grocery_db.cc -I${PWD}/include -L${PWD}/build -ldatabase_lib -o build/grocery_db\ng++ src/movies_db.cc -I${PWD}/include -L${PWD}/build -ldatabase_lib -o build/movies_db\n"})}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.code,{children:"-L${PWD}/build"})," tells the compiler to search this directory for shared objects."]}),"\n",(0,s.jsx)(i.h3,{id:"fix-2-environment-variables-1",children:"Fix 2: Environment Variables"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"export LIBRARY_PATH=${PWD}/build\ng++ src/grocery_db.cc -I${PWD}/include -ldatabase_lib -o build/grocery_db\ng++ src/movies_db.cc -I${PWD}/include -ldatabase_lib -o build/movies_db\n"})}),"\n",(0,s.jsx)(i.h2,{id:"run-the-executable",children:"Run the Executable"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"build/grocery_db\nbuild/movies_db\n"})}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.strong,{children:"You should see the following errror"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"build/grocery_db: error while loading shared libraries: libdatabase_lib.so: cannot open shared object file: No such file or directory\n"})}),"\n",(0,s.jsx)(i.p,{children:"This is because shared objects are loaded dynamically at runtime. Linking is\nonly the last phase of compilation. There are two fixes to this problem:"}),"\n",(0,s.jsx)(i.h3,{id:"fix-1-install-the-shared-objects",children:"Fix 1: Install the shared objects"}),"\n",(0,s.jsx)(i.p,{children:"The OS will search a number of paths by default when loading a program.\nProbably the most popular spots are /usr/lib and /usr/local/lib. You\ncan copy-paste your shared object in this location to resolve the issue.\nThis approach, however, requires root privileges."}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"sudo cp build/libdatabase_lib.so /usr/lib/libdatabase_lib.so\nbuild/grocery_db\nbuild/movies_db\nsudo rm /usr/lib/libdatabase_lib.so\n"})}),"\n",(0,s.jsx)(i.p,{children:"From grocery_db:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"grocery: in create\ngrocery: in read\ngrocery: in update\ngrocery: in delete\n"})}),"\n",(0,s.jsx)(i.p,{children:"From movies_db:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"movies: in create\nmovies: in read\nmovies: in update\nmovies: in delete\n"})}),"\n",(0,s.jsx)(i.h3,{id:"fix-2-environment-variables-2",children:"Fix 2: Environment Variables"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"export LD_LIBRARY_PATH=${PWD}/build:${LD_LIBRARY_PATH}\nbuild/grocery_db\nbuild/movies_db\n"})}),"\n",(0,s.jsx)(i.p,{children:"From grocery_db:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"grocery: in create\ngrocery: in read\ngrocery: in update\ngrocery: in delete\n"})}),"\n",(0,s.jsx)(i.p,{children:"From movies_db:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"movies: in create\nmovies: in read\nmovies: in update\nmovies: in delete\n"})}),"\n",(0,s.jsx)(i.h2,{id:"introduce-compiler-optimization",children:"Introduce Compiler Optimization"}),"\n",(0,s.jsx)(i.p,{children:"One of the things to consider when building code is how optimized you want\nthe code to be. Compilers allow for varying levels of optimization. You\nmay ask, why would I ever want unoptimized code? There are two main reasons:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsx)(i.li,{children:"Some optimizations are dangerous and can break your program"}),"\n",(0,s.jsx)(i.li,{children:"Debugging is much harder since code can get rearranged for optimization"}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"We won't go into detail about every optimization compilers provide. We will\nonly mention the typical optimizations used to make C++ code perform well.\nThe optimizations described in this section are all safe and will not\naffect program correctness."}),"\n",(0,s.jsx)(i.p,{children:'In GCC and Clang, compiler optimization levels are tuned using the "-O"\nparameter. There are four levels of optimization:'}),"\n",(0,s.jsxs)(i.ol,{start:"0",children:["\n",(0,s.jsx)(i.li,{children:"No optimization"}),"\n",(0,s.jsx)(i.li,{children:"Some optimization"}),"\n",(0,s.jsx)(i.li,{children:"Moderate optimization"}),"\n",(0,s.jsx)(i.li,{children:"Heavy optimization"}),"\n"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"# No optimization\ng++ src/database_lib.cc -I${PWD}/include -O0 -fpic -c -o build/database_lib.o\n# Some optimization\ng++ src/database_lib.cc -I${PWD}/include -O1 -fpic -c -o build/database_lib.o\n# Moderate optimization\ng++ src/database_lib.cc -I${PWD}/include -O2 -fpic -c -o build/database_lib.o\n# Heavy optimization\ng++ src/database_lib.cc -I${PWD}/include -O3 -fpic -c -o build/database_lib.o\n"})})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>l,x:()=>t});var a=n(6540);const s={},r=a.createContext(s);function l(e){const i=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function t(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),a.createElement(r.Provider,{value:i},e.children)}}}]);